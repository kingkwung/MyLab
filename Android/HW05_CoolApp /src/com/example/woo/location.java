package com.example.woo;

import android.app.Service;
import android.content.Context;
import android.content.Intent;
import android.location.Criteria;
import android.location.Location;
import android.location.LocationListener;
import android.location.LocationManager;
import android.os.Bundle;
import android.os.IBinder;
import android.os.Looper;
import android.telephony.SmsManager;
import android.util.Log;
import android.widget.Toast;


//?????? ???????????? ??????????????? ??????????????? ???????????? ?????? ???????????????. 


public class location extends Service {
	LocationManager lm;
	
	String phonenum;
	Thread st;

	
	Location lo;

	int inter;
	@Override
	public IBinder onBind(Intent arg0) {
		return null;
	}
	
	//???????????? ??????????????? ???????????? ???????????? ????????????.
	@Override
	public void onStart(Intent intent, int startId) {
		phonenum=intent.getExtras().getString("PHONENUM");
		inter=intent.getExtras().getInt("INTER")*1000;
	
		st = new Thread(new Runnable() {
			public void run() {
				Looper.prepare();				
				for(int i=0;i<10;i++){


					try {
						Thread.sleep(inter);
						getGPSFix_Version1(phonenum,i+1); // coarse: network based
						
					} catch (InterruptedException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}

				}
				Looper.loop();
			}
		});

		st.start(); // get the thread going
	}// onStart
	
	
	
	//????????? ???????????? ????????? ?????????. 
	
	//????????? ????????? ?????? ???????????????. 
	
	LocationListener ll = new LocationListener() {
		public void onLocationChanged(Location _location) {
			lo=_location;
		}

		public void onStatusChanged(String provider, int status, Bundle extras) {
		}

		public void onProviderEnabled(String provider) {
		}

		public void onProviderDisabled(String provider) {
		}
	};	
	
	
	//????????? ??? ????????? 
	//???????????? ??????????????? ???????????????. 
	public void getGPSFix_Version1(String phonenum,int count) {
		LocationManager locationManager = (LocationManager) getSystemService(Context.LOCATION_SERVICE); // work with best available provider
		

		if(locationManager.isProviderEnabled(LocationManager.GPS_PROVIDER)){

			Log.e(null, "GPS _PROVIDER");
			locationManager.requestLocationUpdates(LocationManager.GPS_PROVIDER, 1000, 0, ll);

			lo=locationManager.getLastKnownLocation(LocationManager.GPS_PROVIDER);
			Toast.makeText(this, "GPS GOGO", Toast.LENGTH_LONG).show();

		}
		if(lo==null){
			lo = locationManager.getLastKnownLocation(LocationManager.NETWORK_PROVIDER);
		}else{

		}

		if (lo != null) {

			double latitude = lo.getLatitude();
			double longitude = lo.getLongitude();
		
			sendSMS(phonenum,count,latitude, longitude);
		}

	
	}

	// capture location data sent by current provider

	// GPSListener class
	

	//????????? ????????? ????????? ?????? ??????????????????. 
	public void sendSMS(String phonenum,int count,double lat,double lng){
		SmsManager sms=SmsManager.getDefault();
		sms.sendTextMessage(phonenum, null,"LOCATION "+count+","+lat+","+lng,null,null);
	}
};


